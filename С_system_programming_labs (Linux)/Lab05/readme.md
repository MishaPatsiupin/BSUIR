# Лабораторная работа №5:Потоки исполнения, взаимодействия и синхронизации

## Описание задачи

Основной процесс создает очередь сообщений, после чего ожидает и обрабатывает нажатия клавиш, порождая и завершая процессы двух типов — производители и потребители.

Очередь сообщений представляет собой классическую структуру — кольцевой буфер, содержащий указатели на сообщения, и пара указателей на голову и хвост. Очередь также содержит счетчик добавленных сообщений и счетчик извлеченных.

Производители формируют сообщения и, если в очереди есть место, перемещают их туда. Потребители, если в очереди есть сообщения, извлекают их оттуда, обрабатывают и освобождают память, связанную с ними.

Для работы используются два семафора для заполнения и извлечения, а также мьютекс или одноместный семафор для монопольного доступа к очереди.

Задача производители-потребители для потоков. Аналогична лабораторной No 4, но только с потоками в рамках одного процесса. 
Дополнительно обрабатывается еще две клавиши – увеличение и уменьшение размера очереди. 

## Описание действий при введенных командах

В основном цикле программы ожидается ввод команды от пользователя. В зависимости от введенной команды выполняются следующие действия:

- `'p'`: Создается новый процесс-производитель. Основной процесс создает дочерний процесс с помощью функции `fork()`. Если созданный процесс является дочерним, он начинает выполнять функцию `producer()`. Если процесс является родительским, он добавляет идентификатор нового процесса в список дочерних процессов.
- `'c'`: Создается новый процесс-потребитель. Аналогично команде `'p'`, но дочерний процесс выполняет функцию `consumer()`.
- `'l'`: Отображается список дочерних процессов. Вызывается функция `display_list()`, которая выводит идентификаторы всех дочерних процессов и их тип (производитель или потребитель).
- `'k'`: Удаляется указанный дочерний процесс. Основной процесс ожидает ввода номера процесса, который нужно удалить. Если введенный номер равен 0, выводится сообщение об ошибке. В противном случае процесс с указанным номером удаляется из списка, и ему посылается сигнал `SIGUSR1` для завершения.
- `'q'`: Завершается работа программы. Удаляются все дочерние процессы, освобождается общая память, и основной процесс завершает свою работу.
- `'+'`: Эта команда вставляет элемент в очередь. Шаги следующие:
  1. Мьютекс блокируется с помощью `pthread_mutex_lock(&mutex)` для предотвращения одновременного доступа из других потоков.
  2. Вызывается функция `append(&queue, true)` для добавления элемента в очередь.
  3. Если очередь не пуста, выводится количество элементов в очереди.
  4. Вызывается `sem_post(SEMAPHORE_EMPTY)` для увеличения счетчика семафора, указывающего на количество пустых мест в очереди.
  5. Мьютекс разблокируется с помощью `pthread_mutex_unlock(&mutex)`.

- `'-'`: Эта команда удаляет элемент из очереди. Шаги следующие:
  1. Мьютекс блокируется.
  2. Вызывается функция `erase(&queue)` для удаления элемента из очереди. Эта функция возвращает `true`, если удаление прошло успешно, и `false` в противном случае.
  3. Если `erase` вернул `false`, счетчик `producer_passes` увеличивается. Этот счетчик отслеживает количество попыток производителя добавить элемент в полную очередь.
  4. Если `erase` вернул `true`, счетчик `consumer_passes` увеличивается. Этот счетчик отслеживает количество успешных удалений элементов из очереди.
  5. Мьютекс разблокируется.
    
- Любой другой символ: Выводится сообщение об ошибке, и программа продолжает ожидать ввода команды.

## Формат сообщений

Сообщения имеют следующий формат:


| Имя | Размер     | Смещение | Описание                                          |
| ------ | ---------------- | ---------------- | --------------------------------------------------------- |
| type   | 1                | 0                | тип сообщения                                 |
| hash   | 2                | 1                | контрольные данные                       |
| size   | 1                | 3                | длина данных в байтах (от 0 до 256) |
| data   | ((size + 3)/4)*4 | 4                | данные сообщения                           |

Производители генерируют сообщения, используя системный генератор `rand(3)` для `size` и `data`. В качестве результата для `size` используется остаток от деления на 257.

Если остаток от деления равен нулю, `rand(3)` вызывается повторно. Если остаток от деления равен 256, значение `size` устанавливается равным 0, реальная длина сообщения при этом составляет 256 байт.

При формировании сообщения контрольные данные формируются из всех байт сообщения. Значение поля `hash` при вычислении контрольных данных принимается равным нулю. Для расчета контрольных данных можно использовать любой подходящий алгоритм на выбор студента.

## Работа процессов

После помещения значения в очередь перед освобождением мьютекса очереди производитель инкрементирует счетчик добавленных сообщений. Затем после поднятия семафора выводит строку на stdout, содержащую помимо всего новое значение этого счетчика.

Потребитель, получив доступ к очереди, извлекает сообщение и удаляет его из очереди. Перед освобождением мьютекса очереди инкрементирует счетчик извлеченных сообщений. Затем после поднятия семафора проверяет контрольные данные и выводит строку на stdout, содержащую помимо всего новое значение счетчика извлеченных сообщений.

При получении сигнала о завершении процесс должен завершить свой цикл и только после этого завершиться, не входя в новый.

## Дополнительные требования

- Следует предусмотреть задержки, чтобы вывод можно было успеть прочитать в процессе работы программы.
- Следует предусмотреть защиту от тупиковых ситуаций из-за отсутствия производителей или потребителей.
